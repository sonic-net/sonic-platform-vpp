# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pr:
- main

trigger:
  batch: true
  branches:
    include:
    - main

pool: sonicbld-1es

schedules:
- cron: "0 8 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - main
  always: true

resources:
  repositories:
  - repository: sonic-platform-vpp
    type: github
    name: sonic-net/sonic-platform-vpp
    ref: master
    endpoint: sonic-net
  - repository: buildimage
    type: github
    name: sonic-net/sonic-buildimage
    endpoint: sonic-net
    ref: master

parameters:
  - name: debian_version
    type: string
    default: bookworm
  - name: arch
    type: string
    default: amd64
   
variables:
  - name: BUILD_BRANCH
    ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
      value: $(System.PullRequest.TargetBranch)
    ${{ else }}:
      value: $(Build.SourceBranchName)
  - name: SONIC_BRANCH
    value: master
  - name: CACHE_OPTIONS
    value: SONIC_DPKG_CACHE_METHOD=cache SONIC_DPKG_CACHE_SOURCE=/nfs/dpkg_cache/vpp
  - name: BUILD_OPTIONS
    value: ENABLE_DOCKER_BASE_PULL=y USERNAME=admin SONIC_BUILD_JOBS=$(nproc) PLATFORM=vpp SONIC_VERSION_CONTROL_COMPONENTS=py2,py3,web,git,docker
stages:
- stage: prestage
  jobs:
  - job:
    timeoutInMinutes: 30
    steps:
    - checkout: buildimage
      submodules: recursive
      fetchDepth: 0
      clean: true
      displayName: 'checkout sonic-buildimage'
    - script: |
      set -ex
      git checkout $(SONIC_BRANCH)
      make init
      rm -rf platform/vpp
    - checkout: self
      path: platform/vpp
      displayName: 'checkout sonic-platform-vpp'
    - script: |
      $(BUILD_OPTIONS) $(CACHE_OPTIONS) make configure PLATFORM=vpp
- stage: BuildVpp
  jobs:
  - job:
    displayName: amd64
    timeoutInMinutes: 300
    container:
      image: sonicdev-microsoft.azurecr.io:443/sonic-slave-${{ parameters.debian_version }}:latest
      options:  "--privileged"
    steps:
    - script: |
      $(BUILD_OPTIONS) $(CACHE_OPTIONS) make target/debs/${{ parameters.debian_version }}/libvppinfra_main-release_amd64.deb
      find target/debs/${{ parameters.debian_version }}/ -name "*vpp*.deb" -exec cp {} /$(System.DefaultWorkingDirectory)/artifacts \; 
      displayName: "Build VPP packages from source"
    - publish: $(System.DefaultWorkingDirectory)/artifacts
      artifact: vpp
      displayName: "Archive vpp debian packages"
- stage: BuildSonicVpp
  jobs:
  - job:
    displayName: amd64
    timeoutInMinutes: 300
    steps:
    - script: |
       $(BUILD_OPTIONS) $(CACHE_OPTIONS) make target/sonic-vpp.img.gz
      displayName: "Build sonic-vpp image"
    - publish: $(System.DefaultWorkingDirectory)/target/sonic-vpp.img.gz
      artifact: sonic-vpp
      displayName: "Archive sonic-vpp image"

