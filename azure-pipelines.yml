# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pr:    
- main

trigger:
  batch: true
  branches:
    include:
    - main

parameters:
  - name: debian_version
    type: string
    default: bookworm
  - name: arch
    type: string
    default: amd64
   
variables:
  - name: BUILD_BRANCH
    ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
      value: $(System.PullRequest.TargetBranch)
    ${{ else }}:
      value: $(Build.SourceBranchName)

stages:
- stage: BuildVpp
  
  jobs:
  - job:
    displayName: amd64
    timeoutInMinutes: 300
    pool: sonicbld
    container:
      image: sonicdev-microsoft.azurecr.io:443/sonic-slave-${{ parameters.debian_version }}:latest
      options:  "--privileged"
    steps:
    - checkout: self
      clean: true
    - script: |
        set -ex
        git clone https://github.com/sonic-net/sonic-platform-vpp.git
        mkdir repo
        git clone https://gerrit.fd.io/r/vpp repo
        cp -vr sonic-platform-vpp/vppbld/plugins/* repo/src/packages
        cd repo
        git apply ../sonic-platform-vpp/vppbld/vpp.patch
        make UNATTENDED=y PLATFORM=vpp install-deps install-ext-deps
        make UNATTENDED=y PLATFORM=vpp -j4 pkg-deb
        mkdir artifacts
        mv build-root/*.deb artifacts/
      displayName: "Build VPP packages from source"
    - publish: $(System.DefaultWorkingDirectory)/repo/artifacts
      artifact: vpp
      displayName: "Archive vpp debian packages"
